<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}英文單字筆記本{% endblock %}</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <!-- 主題系統 CSS -->
    <link href="{{ url_for('static', filename='css/themes.css') }}" rel="stylesheet">

    <style>
        .navbar-brand {
            font-weight: bold;
        }
        .card-header {
            background-color: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }
        .status-badge {
            font-size: 0.8em;
        }
        .api-key-input {
            font-family: monospace;
        }
        .config-section {
            margin-bottom: 2rem;
        }
        .provider-card {
            transition: all 0.3s ease;
        }
        .provider-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-success { background-color: #28a745; }
        .status-warning { background-color: #ffc107; }
        .status-danger { background-color: #dc3545; }

        .form-floating > .form-control:focus ~ label,
        .form-floating > .form-control:not(:placeholder-shown) ~ label {
            opacity: .65;
            transform: scale(.85) translateY(-0.5rem) translateX(0.15rem);
        }
    </style>

    {% block extra_css %}{% endblock %}
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('index') }}">
                <i class="bi bi-book"></i> 英文單字筆記本
            </a>

            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('index') }}">
                            <i class="bi bi-house"></i> 首頁
                        </a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                            <i class="bi bi-plus-circle"></i> 新增單字
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="{{ url_for('add_word') }}">
                                <i class="bi bi-plus-circle"></i> 單個新增
                            </a></li>
                            <li><a class="dropdown-item" href="{{ url_for('batch_add_words') }}">
                                <i class="bi bi-plus-square"></i> 批次新增
                            </a></li>
                        </ul>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('random_review') }}">
                            <i class="bi bi-shuffle"></i> 隨機複習
                        </a>
                    </li>
                </ul>

                <ul class="navbar-nav">
                    <!-- 主題切換器 -->
                    <li class="nav-item dropdown me-2">
                        <a class="nav-link dropdown-toggle theme-selector" href="#" role="button" data-bs-toggle="dropdown" id="themeSelector">
                            <i class="bi bi-palette"></i> <span class="d-none d-md-inline">主題</span>
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item theme-option d-flex align-items-center" href="#" data-theme="orange">
                                <div class="theme-color-preview orange me-2"></div>
                                <span>橘色主題</span>
                            </a></li>
                            <li><a class="dropdown-item theme-option d-flex align-items-center" href="#" data-theme="blue">
                                <div class="theme-color-preview blue me-2"></div>
                                <span>藍色主題</span>
                            </a></li>
                            <li><a class="dropdown-item theme-option d-flex align-items-center" href="#" data-theme="green">
                                <div class="theme-color-preview green me-2"></div>
                                <span>綠色主題</span>
                            </a></li>
                            <li><a class="dropdown-item theme-option d-flex align-items-center" href="#" data-theme="gray">
                                <div class="theme-color-preview gray me-2"></div>
                                <span>灰色主題</span>
                            </a></li>
                        </ul>
                    </li>

                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                            <i class="bi bi-gear"></i> 設定
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="{{ url_for('settings') }}">
                                <i class="bi bi-sliders"></i> 一般設定
                            </a></li>
                            <li><a class="dropdown-item" href="{{ url_for('api_settings') }}">
                                <i class="bi bi-robot"></i> AI API 設定
                            </a></li>
                        </ul>
                    </li>

                    <!-- 身份驗證狀態 -->
                    <li class="nav-item" id="authStatusItem" style="display: none;">
                        <span class="navbar-text me-2">
                            <i class="bi bi-shield-check text-success"></i>
                            <small class="d-none d-md-inline">已認證</small>
                        </span>
                    </li>

                    <!-- 登出按鈕 -->
                    <li class="nav-item" id="logoutItem" style="display: none;">
                        <a class="nav-link" href="{{ url_for('logout') }}" onclick="handleLogout(event)">
                            <i class="bi bi-box-arrow-right"></i> <span class="d-none d-md-inline">登出</span>
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Flash Messages -->
    <div class="container mt-3">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'danger' if category == 'error' else 'success' if category == 'success' else 'info' }} alert-dismissible fade show" role="alert">
                        <i class="bi bi-{{ 'exclamation-triangle' if category == 'error' else 'check-circle' if category == 'success' else 'info-circle' }}"></i>
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
    </div>

    <!-- Main Content -->
    <main class="container mt-4">
        {% block content %}{% endblock %}
    </main>

    <!-- Footer -->
    <footer class="bg-light mt-5 py-4">
        <div class="container text-center text-muted">
            <p>&copy; 2025 英文單字筆記本. 使用 Flask 和 AI 技術打造.</p>
        </div>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- 通知系統 -->
    <script src="{{ url_for('static', filename='js/notification-system.js') }}"></script>

    <!-- 主題切換 JavaScript -->
    <script>
        // 主題切換功能
        document.addEventListener('DOMContentLoaded', function() {
            const themeOptions = document.querySelectorAll('[data-theme]');
            const body = document.body;

            // 主題名稱映射
            const themeNames = {
                'orange': '橘色主題',
                'blue': '藍色主題',
                'green': '綠色主題',
                'gray': '灰色主題'
            };

            // 載入儲存的主題，預設為橘色
            const savedTheme = localStorage.getItem('vocabulary-theme') || 'orange';
            applyTheme(savedTheme);

            // 主題切換事件監聽
            themeOptions.forEach(option => {
                option.addEventListener('click', function(e) {
                    e.preventDefault();
                    const theme = this.getAttribute('data-theme');
                    applyTheme(theme);
                    localStorage.setItem('vocabulary-theme', theme);

                    // 顯示切換成功提示
                    showThemeChangeNotification(themeNames[theme]);
                });
            });

            function applyTheme(theme) {
                // 移除所有主題類別
                body.removeAttribute('data-theme');

                // 應用新主題（橘色是預設，不需要data-theme屬性）
                if (theme !== 'orange') {
                    body.setAttribute('data-theme', theme);
                }

                // 更新主題選擇器顯示
                updateThemeSelector(theme);
            }

            function updateThemeSelector(currentTheme) {
                const selector = document.getElementById('themeSelector');

                // 更新選擇器內容，不顯示圓圈預覽
                selector.innerHTML = `
                    <i class="bi bi-palette"></i>
                    <span class="d-none d-md-inline">${themeNames[currentTheme]}</span>
                `;

                // 更新下拉選單中的選中狀態
                themeOptions.forEach(option => {
                    const parent = option.parentElement;
                    if (option.getAttribute('data-theme') === currentTheme) {
                        parent.classList.add('active');
                        // 檢查是否已經有勾選圖示
                        if (!option.innerHTML.includes('bi-check')) {
                            option.innerHTML = option.innerHTML + ' <i class="bi bi-check float-end"></i>';
                        }
                    } else {
                        parent.classList.remove('active');
                        option.innerHTML = option.innerHTML.replace(' <i class="bi bi-check float-end"></i>', '');
                    }
                });
            }

            function showThemeChangeNotification(themeName) {
                // 創建通知元素
                const notification = document.createElement('div');
                notification.className = 'alert alert-success alert-dismissible fade show position-fixed';
                notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 250px;';
                notification.innerHTML = `
                    <i class="bi bi-palette"></i>
                    已切換至 ${themeName}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;

                document.body.appendChild(notification);

                // 3秒後自動移除
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 3000);
            }
        });

        // 身份驗證狀態管理
        function checkAuthStatus() {
            fetch('/auth/status')
                .then(response => response.json())
                .then(data => {
                    const authStatusItem = document.getElementById('authStatusItem');
                    const logoutItem = document.getElementById('logoutItem');

                    if (data.passcode_required && data.authenticated) {
                        // 顯示認證狀態和登出按鈕
                        if (authStatusItem) authStatusItem.style.display = 'block';
                        if (logoutItem) logoutItem.style.display = 'block';

                        // 更新身份驗證狀態顯示
                        updateAuthDisplay(data.session_info);
                    } else {
                        // 隱藏認證相關UI
                        if (authStatusItem) authStatusItem.style.display = 'none';
                        if (logoutItem) logoutItem.style.display = 'none';
                    }
                })
                .catch(error => {
                    console.warn('檢查身份驗證狀態失敗:', error);
                });
        }

        function updateAuthDisplay(sessionInfo) {
            const authStatusItem = document.getElementById('authStatusItem');
            if (!authStatusItem || !sessionInfo) return;

            const statusSpan = authStatusItem.querySelector('span');
            if (!statusSpan) return;

            let statusHTML = '<i class="bi bi-shield-check text-success"></i>';

            if (sessionInfo.time_remaining_minutes !== undefined) {
                const hours = Math.floor(sessionInfo.time_remaining_minutes / 60);
                const minutes = sessionInfo.time_remaining_minutes % 60;

                let timeText = '';
                if (hours > 0) {
                    timeText = `${hours}小時`;
                    if (minutes > 0) timeText += `${minutes}分`;
                } else {
                    timeText = `${minutes}分鐘`;
                }

                statusHTML += ` <small class="d-none d-lg-inline text-muted">(${timeText}後登出)</small>`;
            } else {
                statusHTML += ' <small class="d-none d-md-inline">已認證</small>';
            }

            statusSpan.innerHTML = statusHTML;
        }

        // 定期檢查身份驗證狀態
        function startAuthStatusCheck() {
            checkAuthStatus(); // 立即檢查一次

            // 每30秒檢查一次
            setInterval(checkAuthStatus, 30000);
        }

        // 頁面載入後開始檢查
        startAuthStatusCheck();

        // 監聽頁面可見性變化，當用戶回到頁面時檢查狀態
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                checkAuthStatus();
            }
        });

        // 處理登出確認
        window.handleLogout = async function(event) {
            event.preventDefault();
            const confirmed = await showConfirm('確定要登出嗎？', '確認登出');
            if (confirmed) {
                window.location.href = event.target.href;
            }
        };
    </script>

    {% block extra_js %}{% endblock %}
</body>
</html>