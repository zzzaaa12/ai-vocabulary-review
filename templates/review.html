{% extends "base.html" %}

{% block title %}隨機複習 - 英文單字筆記本{% endblock %}

{% block extra_css %}
<style>
    .review-progress {
        height: 8px;
        background-color: #e9ecef;
        border-radius: 4px;
        overflow: hidden;
    }

    .review-progress-bar {
        height: 100%;
        background: linear-gradient(90deg, #28a745, #20c997);
        transition: width 0.3s ease;
    }

    .word-table {
        background: white;
        border-radius: 0.5rem;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .word-row {
        transition: background-color 0.2s ease;
        border-bottom: 1px solid #f8f9fa;
    }

    .word-row:hover {
        background-color: #f8f9fa;
    }

    .word-row.difficult {
        background-color: #fff3cd;
        border-left: 4px solid #ffc107;
    }

    .word-cell {
        padding: 1rem;
        vertical-align: middle;
    }

    .word-text {
        font-size: 1.1rem;
        font-weight: 600;
        color: #0d6efd;
    }

    .phonetic-text {
        font-family: 'Courier New', monospace;
        color: #6c757d;
        font-size: 0.95rem;
    }

    .meaning-text {
        color: #198754;
        font-size: 1rem;
    }

    .hidden-content {
        color: transparent;
        background-color: #e9ecef;
        border-radius: 4px;
        cursor: pointer;
        user-select: none;
        transition: all 0.3s ease;
    }

    .hidden-content:hover {
        background-color: #dee2e6;
    }

    .hidden-content.revealed {
        color: inherit;
        background-color: transparent;
    }

    .difficulty-btn {
        border: none;
        background: none;
        color: #6c757d;
        font-size: 1.2rem;
        cursor: pointer;
        transition: color 0.2s ease;
    }

    .difficulty-btn:hover {
        color: #ffc107;
    }

    .difficulty-btn.marked {
        color: #ffc107;
    }

    .settings-panel {
        background: #f8f9fa;
        border-radius: 0.5rem;
        padding: 1rem;
        margin-bottom: 1rem;
    }

    .batch-info {
        font-size: 1.1rem;
        font-weight: 500;
    }

    .control-buttons {
        margin-top: 2rem;
        text-align: center;
    }

    @media (max-width: 768px) {
        .word-cell {
            padding: 0.75rem 0.5rem;
        }

        .word-text {
            font-size: 1rem;
        }

        .phonetic-text,
        .meaning-text {
            font-size: 0.9rem;
        }

        .settings-panel {
            padding: 0.75rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- 頂部進度條和設定 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h2>
                    <i class="bi bi-shuffle"></i> 隨機複習
                </h2>
                <div class="d-flex align-items-center gap-3">
                    <span class="batch-info text-muted">
                        第 <span id="currentBatch">1</span> 組
                        (<span id="batchRange">1-20</span> / {{ total_words }})
                    </span>
                    <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">
                        <i class="bi bi-x-lg"></i> 結束複習
                    </a>
                </div>
            </div>
            <div class="review-progress">
                <div class="review-progress-bar" id="progressBar" style="width: 0%"></div>
            </div>
        </div>
    </div>

    <!-- 設定面板 -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="settings-panel">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <div class="d-flex gap-3 align-items-center">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="showPhonetic" checked>
                                <label class="form-check-label" for="showPhonetic">顯示音標</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="showMeaning" checked>
                                <label class="form-check-label" for="showMeaning">顯示中文</label>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 text-md-end">
                        <button class="btn btn-sm btn-outline-primary" onclick="toggleAllHidden()">
                            <i class="bi bi-eye-slash"></i> 全部隱藏/顯示
                        </button>
                        <button class="btn btn-sm btn-outline-warning" onclick="showDifficultWords()">
                            <i class="bi bi-star"></i> 困難單字 (<span id="difficultCount">0</span>)
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 單字列表 -->
    <div class="row">
        <div class="col-12">
            <div class="word-table">
                <table class="table table-hover mb-0" id="wordsTable">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 30%">單字</th>
                            <th style="width: 25%">音標</th>
                            <th style="width: 35%">中文解釋</th>
                            <th style="width: 10%" class="text-center">標記</th>
                        </tr>
                    </thead>
                    <tbody id="wordsTableBody">
                        <!-- 動態生成內容 -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 控制按鈕 -->
    <div class="control-buttons">
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-outline-primary" id="prevBtn" onclick="previousBatch()">
                <i class="bi bi-chevron-left"></i> 上一組
            </button>
            <button type="button" class="btn btn-outline-secondary" onclick="shuffleCurrentBatch()">
                <i class="bi bi-shuffle"></i> 重新排序
            </button>
            <button type="button" class="btn btn-outline-primary" id="nextBtn" onclick="nextBatch()">
                下一組 <i class="bi bi-chevron-right"></i>
            </button>
        </div>
    </div>

    <!-- 困難單字 Modal -->
    <div class="modal fade" id="difficultWordsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-star-fill text-warning"></i> 困難單字列表
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="difficultWordsList">
                        <!-- 動態生成困難單字列表 -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" onclick="clearAllDifficult()">
                        <i class="bi bi-trash"></i> 清除全部標記
                    </button>
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">關閉</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 複習統計 Modal -->
    <div class="modal fade" id="reviewStatsModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-trophy"></i> 複習完成！
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <div class="mb-4">
                        <i class="bi bi-check-circle-fill text-success" style="font-size: 3rem;"></i>
                    </div>
                    <h4>恭喜完成複習！</h4>
                    <p class="text-muted">您已經複習了 <strong>{{ total_words }}</strong> 個單字</p>

                    <div class="row text-center mt-4">
                        <div class="col-4">
                            <div class="h3 text-primary" id="totalWordsCount">{{ total_words }}</div>
                            <small class="text-muted">總單字數</small>
                        </div>
                        <div class="col-4">
                            <div class="h3 text-warning" id="finalDifficultCount">0</div>
                            <small class="text-muted">困難單字</small>
                        </div>
                        <div class="col-4">
                            <div class="h3 text-success" id="reviewTime">0</div>
                            <small class="text-muted">複習時間(分)</small>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" onclick="restartReview()">
                        <i class="bi bi-arrow-repeat"></i> 重新複習
                    </button>
                    <button type="button" class="btn btn-outline-warning" onclick="reviewDifficultOnly()">
                        <i class="bi bi-star"></i> 只複習困難單字
                    </button>
                    <a href="{{ url_for('index') }}" class="btn btn-primary">
                        <i class="bi bi-house"></i> 返回首頁
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // 複習資料
    const words = {{ words | tojson }};
    const BATCH_SIZE = 20;
    let currentBatchIndex = 0;
    let startTime = new Date();
    let difficultWords = new Set();
    let allHidden = false;

    // 初始化
    document.addEventListener('DOMContentLoaded', function () {
        if (words.length === 0) {
            showInfo('沒有單字可以複習');
            window.location.href = '{{ url_for("index") }}';
            return;
        }

        displayCurrentBatch();
        updateProgress();
        updateButtons();
        setupEventListeners();
    });

    // 設定事件監聽器
    function setupEventListeners() {
        document.getElementById('showPhonetic').addEventListener('change', updateColumnVisibility);
        document.getElementById('showMeaning').addEventListener('change', updateColumnVisibility);
    }

    // 顯示當前批次的單字
    function displayCurrentBatch() {
        const startIndex = currentBatchIndex * BATCH_SIZE;
        const endIndex = Math.min(startIndex + BATCH_SIZE, words.length);
        const batchWords = words.slice(startIndex, endIndex);

        const tbody = document.getElementById('wordsTableBody');
        tbody.innerHTML = '';

        batchWords.forEach((word, index) => {
            const globalIndex = startIndex + index;
            const row = createWordRow(word, globalIndex);
            tbody.appendChild(row);
        });

        updateColumnVisibility();
    }

    // 創建單字行
    function createWordRow(word, globalIndex) {
        const row = document.createElement('tr');
        row.className = 'word-row';
        row.dataset.wordId = globalIndex;

        if (difficultWords.has(globalIndex)) {
            row.classList.add('difficult');
        }

        row.innerHTML = `
        <td class="word-cell">
            <div class="word-text">${word.word}</div>
        </td>
        <td class="word-cell phonetic-column">
            <div class="d-flex align-items-center">
                <button class="btn btn-outline-primary btn-sm review-pronunciation-btn me-2"
                        data-word="${word.word}"
                        title="播放發音">
                    <i class="bi bi-volume-up"></i>
                </button>
                <div class="phonetic-text phonetic-content" onclick="toggleReveal(this)">
                    ${word.phonetic || ''}
                </div>
            </div>
        </td>
        <td class="word-cell meaning-column">
            <div class="meaning-text meaning-content" onclick="toggleReveal(this)">
                ${word.chinese_meaning}
            </div>
        </td>
        <td class="word-cell text-center">
            <button class="difficulty-btn ${difficultWords.has(globalIndex) ? 'marked' : ''}"
                    onclick="toggleDifficulty(${globalIndex}, this)">
                <i class="bi bi-star${difficultWords.has(globalIndex) ? '-fill' : ''}"></i>
            </button>
        </td>
    `;

        return row;
    }

    // 切換顯示/隱藏內容
    function toggleReveal(element) {
        element.classList.toggle('revealed');
    }

    // 切換困難標記
    function toggleDifficulty(wordIndex, button) {
        const row = document.querySelector(`tr[data-word-id="${wordIndex}"]`);
        const icon = button.querySelector('i');

        if (difficultWords.has(wordIndex)) {
            difficultWords.delete(wordIndex);
            button.classList.remove('marked');
            icon.className = 'bi bi-star';
            row.classList.remove('difficult');
        } else {
            difficultWords.add(wordIndex);
            button.classList.add('marked');
            icon.className = 'bi bi-star-fill';
            row.classList.add('difficult');
        }

        updateDifficultCount();
    }

    // 更新困難單字計數
    function updateDifficultCount() {
        document.getElementById('difficultCount').textContent = difficultWords.size;
    }

    // 更新欄位可見性
    function updateColumnVisibility() {
        const showPhonetic = document.getElementById('showPhonetic').checked;
        const showMeaning = document.getElementById('showMeaning').checked;

        // 更新表頭
        const phoneticHeaders = document.querySelectorAll('th:nth-child(2)');
        const meaningHeaders = document.querySelectorAll('th:nth-child(3)');

        phoneticHeaders.forEach(th => th.style.display = showPhonetic ? '' : 'none');
        meaningHeaders.forEach(th => th.style.display = showMeaning ? '' : 'none');

        // 更新表格內容
        const phoneticCells = document.querySelectorAll('.phonetic-column');
        const meaningCells = document.querySelectorAll('.meaning-column');

        phoneticCells.forEach(cell => cell.style.display = showPhonetic ? '' : 'none');
        meaningCells.forEach(cell => cell.style.display = showMeaning ? '' : 'none');

        // 如果隱藏了欄位，自動隱藏內容
        if (!showPhonetic) {
            document.querySelectorAll('.phonetic-content').forEach(el => {
                el.classList.add('hidden-content');
                el.classList.remove('revealed');
            });
        }

        if (!showMeaning) {
            document.querySelectorAll('.meaning-content').forEach(el => {
                el.classList.add('hidden-content');
                el.classList.remove('revealed');
            });
        }
    }

    // 全部隱藏/顯示切換
    function toggleAllHidden() {
        allHidden = !allHidden;
        const phoneticContents = document.querySelectorAll('.phonetic-content');
        const meaningContents = document.querySelectorAll('.meaning-content');

        [...phoneticContents, ...meaningContents].forEach(el => {
            if (allHidden) {
                el.classList.add('hidden-content');
                el.classList.remove('revealed');
            } else {
                el.classList.remove('hidden-content');
                el.classList.add('revealed');
            }
        });
    }

    // 下一批次
    function nextBatch() {
        const totalBatches = Math.ceil(words.length / BATCH_SIZE);

        if (currentBatchIndex < totalBatches - 1) {
            currentBatchIndex++;
            displayCurrentBatch();
            updateProgress();
            updateButtons();
            scrollToTop();
        } else {
            // 複習完成
            showReviewStats();
        }
    }

    // 上一批次
    function previousBatch() {
        if (currentBatchIndex > 0) {
            currentBatchIndex--;
            displayCurrentBatch();
            updateProgress();
            updateButtons();
            scrollToTop();
        }
    }

    // 重新排序當前批次
    function shuffleCurrentBatch() {
        const startIndex = currentBatchIndex * BATCH_SIZE;
        const endIndex = Math.min(startIndex + BATCH_SIZE, words.length);
        const batchWords = words.slice(startIndex, endIndex);

        // 打亂當前批次
        for (let i = batchWords.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [batchWords[i], batchWords[j]] = [batchWords[j], batchWords[i]];
        }

        // 更新原陣列
        words.splice(startIndex, batchWords.length, ...batchWords);

        displayCurrentBatch();
    }

    // 更新進度條和批次資訊
    function updateProgress() {
        const totalBatches = Math.ceil(words.length / BATCH_SIZE);
        const progress = ((currentBatchIndex + 1) / totalBatches) * 100;

        document.getElementById('progressBar').style.width = progress + '%';
        document.getElementById('currentBatch').textContent = currentBatchIndex + 1;

        const startIndex = currentBatchIndex * BATCH_SIZE + 1;
        const endIndex = Math.min((currentBatchIndex + 1) * BATCH_SIZE, words.length);
        document.getElementById('batchRange').textContent = `${startIndex}-${endIndex}`;
    }

    // 更新按鈕狀態
    function updateButtons() {
        const totalBatches = Math.ceil(words.length / BATCH_SIZE);

        document.getElementById('prevBtn').disabled = currentBatchIndex === 0;

        const nextBtn = document.getElementById('nextBtn');
        if (currentBatchIndex === totalBatches - 1) {
            nextBtn.innerHTML = '完成複習 <i class="bi bi-check-lg"></i>';
            nextBtn.classList.remove('btn-outline-primary');
            nextBtn.classList.add('btn-success');
        } else {
            nextBtn.innerHTML = '下一組 <i class="bi bi-chevron-right"></i>';
            nextBtn.classList.remove('btn-success');
            nextBtn.classList.add('btn-outline-primary');
        }
    }

    // 顯示困難單字
    function showDifficultWords() {
        const difficultWordsList = document.getElementById('difficultWordsList');

        if (difficultWords.size === 0) {
            difficultWordsList.innerHTML = '<p class="text-muted text-center">尚未標記任何困難單字</p>';
        } else {
            let html = '<div class="row">';

            Array.from(difficultWords).forEach(wordIndex => {
                const word = words[wordIndex];
                html += `
                <div class="col-md-6 mb-3">
                    <div class="card">
                        <div class="card-body">
                            <h6 class="card-title text-primary">${word.word}</h6>
                            <p class="card-text small text-muted">${word.phonetic || ''}</p>
                            <p class="card-text">${word.chinese_meaning}</p>
                        </div>
                    </div>
                </div>
            `;
            });

            html += '</div>';
            difficultWordsList.innerHTML = html;
        }

        const modal = new bootstrap.Modal(document.getElementById('difficultWordsModal'));
        modal.show();
    }

    // 清除所有困難標記
    function clearAllDifficult() {
        difficultWords.clear();
        updateDifficultCount();
        displayCurrentBatch();

        const modal = bootstrap.Modal.getInstance(document.getElementById('difficultWordsModal'));
        modal.hide();
    }

    // 顯示複習統計
    function showReviewStats() {
        const endTime = new Date();
        const reviewTimeMinutes = Math.round((endTime - startTime) / 60000);

        document.getElementById('reviewTime').textContent = reviewTimeMinutes;
        document.getElementById('finalDifficultCount').textContent = difficultWords.size;

        const modal = new bootstrap.Modal(document.getElementById('reviewStatsModal'));
        modal.show();
    }

    // 重新開始複習
    function restartReview() {
        currentBatchIndex = 0;
        difficultWords.clear();
        startTime = new Date();
        allHidden = false;

        // 重新打亂單字順序
        for (let i = words.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [words[i], words[j]] = [words[j], words[i]];
        }

        displayCurrentBatch();
        updateProgress();
        updateButtons();
        updateDifficultCount();

        // 關閉統計 Modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('reviewStatsModal'));
        modal.hide();
    }

    // 只複習困難單字
    function reviewDifficultOnly() {
        if (difficultWords.size === 0) {
            alert('沒有標記困難的單字');
            return;
        }

        // 創建只包含困難單字的新陣列
        const difficultWordsArray = Array.from(difficultWords).map(index => words[index]);

        // 重新導向到新的複習頁面（這裡可以考慮添加參數或新的路由）
        // 暫時用當前頁面重新載入
        window.location.href = '{{ url_for("random_review") }}';
    }

    // 滾動到頂部
    function scrollToTop() {
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // 鍵盤快捷鍵
    document.addEventListener('keydown', function (e) {
        switch (e.key) {
            case 'ArrowLeft':
                e.preventDefault();
                previousBatch();
                break;
            case 'ArrowRight':
                e.preventDefault();
                nextBatch();
                break;
            case ' ':
                e.preventDefault();
                toggleAllHidden();
                break;
            case 'Escape':
                window.location.href = '{{ url_for("index") }}';
                break;
        }
    });

    // 防止意外離開
    window.addEventListener('beforeunload', function (e) {
        if (currentBatchIndex > 0 || difficultWords.size > 0) {
            e.preventDefault();
            e.returnValue = '您的複習進度將會遺失，確定要離開嗎？';
        }
    });

    // 複習頁面發音功能
    document.addEventListener('click', function(e) {
        if (e.target.closest('.review-pronunciation-btn')) {
            const btn = e.target.closest('.review-pronunciation-btn');
            const word = btn.getAttribute('data-word');
            if (word) {
                playReviewPronunciation(btn, word);
            }
        }
    });

    function playReviewPronunciation(btn, word) {
        const originalContent = btn.innerHTML;

        // 設置載入狀態
        btn.innerHTML = '<i class="bi bi-hourglass-split"></i>';
        btn.disabled = true;

        // 構造音頻URL
        const audioUrl = `https://s.yimg.com/bg/dict/dreye/live/m/${word.toLowerCase()}.mp3`;
        console.log('複習頁面播放音頻:', audioUrl);

        // 創建音頻元素
        const audio = new Audio();

        // 音頻載入成功
        audio.addEventListener('canplay', function() {
            console.log('複習音頻載入成功:', word);
            btn.innerHTML = '<i class="bi bi-play-fill"></i>';
            btn.title = '播放中...';

            audio.play().then(() => {
                console.log('複習音頻播放開始:', word);
            }).catch((error) => {
                console.error('複習播放失敗:', error);
                handleReviewPlaybackError();
            });
        });

        // 音頻播放結束
        audio.addEventListener('ended', function() {
            console.log('複習音頻播放結束:', word);
            btn.innerHTML = originalContent;
            btn.disabled = false;
            btn.title = '播放發音';
        });

        // 音頻載入錯誤
        audio.addEventListener('error', function(e) {
            console.error('複習音頻載入錯誤:', e);
            handleReviewPlaybackError();
        });

        // 處理播放錯誤
        function handleReviewPlaybackError() {
            btn.innerHTML = '<i class="bi bi-volume-mute text-muted"></i>';
            btn.disabled = false;
            btn.title = '無法載入發音';

            // 顯示錯誤提示
            showReviewNotification(`單字 "${word}" 暫無發音資源`, 'warning');

            // 3秒後恢復原狀
            setTimeout(() => {
                btn.innerHTML = originalContent;
                btn.title = '播放發音';
            }, 3000);
        }

        // 設置音頻源並開始載入
        audio.src = audioUrl;
        audio.load();

        // 設置超時處理
        setTimeout(() => {
            if (btn.disabled && btn.innerHTML.includes('hourglass')) {
                console.log('複習載入超時:', word);
                handleReviewPlaybackError();
            }
        }, 10000);
    }

    function showReviewNotification(message, type = 'info') {
        // 先移除現有的通知
        const existingNotifications = document.querySelectorAll('.review-pronunciation-notification');
        existingNotifications.forEach(n => n.remove());

        // 選擇圖示
        let icon = 'bi-info-circle';
        if (type === 'success') icon = 'bi-check-circle';
        else if (type === 'warning') icon = 'bi-exclamation-triangle';
        else if (type === 'danger') icon = 'bi-x-circle';

        // 創建通知元素
        const notification = document.createElement('div');
        notification.className = `alert alert-${type} alert-dismissible fade show position-fixed review-pronunciation-notification`;
        notification.style.cssText = 'top: 80px; right: 20px; z-index: 9999; min-width: 320px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);';
        notification.innerHTML = `
            <i class="bi ${icon}"></i> ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;

        // 添加到頁面
        document.body.appendChild(notification);

        // 自動移除
        setTimeout(() => {
            if (notification.parentNode) {
                notification.classList.remove('show');
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 300);
            }
        }, 3000);
    }
</script>
{% endblock %}