{% extends "base.html" %}

{% block title %}{{ word.word }} - 單字詳細資訊{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>
                <i class="bi bi-book-half"></i> 單字詳細資訊
            </h1>
            <div>
                <a href="{{ url_for('index') }}" class="btn btn-outline-secondary me-2">
                    <i class="bi bi-arrow-left"></i> 返回列表
                </a>
                <a href="{{ url_for('edit_word', word_id=word.id) }}" class="btn btn-primary me-2">
                    <i class="bi bi-pencil"></i> 編輯
                </a>
                <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#deleteModal">
                    <i class="bi bi-trash"></i> 刪除
                </button>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title mb-0">
                    {{ word.word }}
                    {% if word.phonetic %}
                        <span class="badge bg-light text-dark ms-2">{{ word.phonetic }}</span>
                    {% endif %}
                    <button id="pronunciationBtn" class="btn btn-outline-primary btn-sm ms-2" title="播放發音">
                        <i class="bi bi-volume-up"></i>
                    </button>
                </h3>
            </div>
            <div class="card-body">
                <!-- 中文翻譯 -->
                <div class="mb-4">
                    <h5 class="text-primary">
                        <i class="bi bi-translate"></i> 中文翻譯
                    </h5>
                    <p class="fs-5">{{ word.chinese_meaning }}</p>
                </div>

                <!-- 英文定義 -->
                {% if word.english_meaning %}
                <div class="mb-4">
                    <h5 class="text-info">
                        <i class="bi bi-book"></i> 英文定義
                    </h5>
                    <p class="text-muted">{{ word.english_meaning }}</p>
                </div>
                {% endif %}

                <!-- 例句 -->
                {% if word.example_sentence %}
                <div class="mb-4">
                    <h5 class="text-success">
                        <i class="bi bi-chat-quote"></i> 例句
                    </h5>
                    <blockquote class="blockquote">
                        <p class="fst-italic">"{{ word.example_sentence }}"</p>
                    </blockquote>
                </div>
                {% endif %}

                <!-- 同義詞和反義詞 -->
                {% if word.synonyms or word.antonyms %}
                <div class="row">
                    {% if word.synonyms %}
                    <div class="col-md-6 mb-4">
                        <h5 class="text-success">
                            <i class="bi bi-arrow-right-circle"></i> 同義詞
                        </h5>
                        <div class="d-flex flex-wrap gap-2">
                            {% for synonym in word.synonyms %}
                                <span class="badge bg-success-subtle text-success-emphasis">{{ synonym }}</span>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    {% if word.antonyms %}
                    <div class="col-md-6 mb-4">
                        <h5 class="text-danger">
                            <i class="bi bi-arrow-left-circle"></i> 反義詞
                        </h5>
                        <div class="d-flex flex-wrap gap-2">
                            {% for antonym in word.antonyms %}
                                <span class="badge bg-danger-subtle text-danger-emphasis">{{ antonym }}</span>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <!-- 單字資訊卡片 -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="bi bi-info-circle"></i> 單字資訊
                </h6>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <strong>建立時間:</strong><br>
                    <small class="text-muted">{{ word.created_date.strftime('%Y年%m月%d日 %H:%M') }}</small>
                </div>
                <div class="mb-3">
                    <strong>最後更新:</strong><br>
                    <small class="text-muted">{{ word.updated_date.strftime('%Y年%m月%d日 %H:%M') }}</small>
                </div>
                <div class="mb-3">
                    <strong>單字ID:</strong><br>
                    <small class="text-muted font-monospace">{{ word.id }}</small>
                </div>
            </div>
        </div>

        <!-- 快速操作卡片 -->
        <div class="card">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="bi bi-lightning"></i> 快速操作
                </h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{{ url_for('edit_word', word_id=word.id) }}" class="btn btn-primary">
                        <i class="bi bi-pencil"></i> 編輯單字
                    </a>
                    <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteModal">
                        <i class="bi bi-trash"></i> 刪除單字
                    </button>
                    <hr>
                    <a href="{{ url_for('add_word') }}" class="btn btn-outline-success">
                        <i class="bi bi-plus-circle"></i> 新增單字
                    </a>
                    <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">
                        <i class="bi bi-list"></i> 單字列表
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 刪除確認 Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-danger">
                    <i class="bi bi-exclamation-triangle"></i> 確認刪除
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>確定要刪除單字 <strong>"{{ word.word }}"</strong> 嗎？</p>
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i>
                    <strong>注意：</strong>此操作無法復原，單字的所有資訊都會被永久刪除。
                </div>
                <div class="bg-light p-3 rounded">
                    <strong>將被刪除的資訊：</strong>
                    <ul class="mb-0 mt-2">
                        <li>單字：{{ word.word }}</li>
                        <li>中文翻譯：{{ word.chinese_meaning }}</li>
                        {% if word.english_meaning %}<li>英文定義：{{ word.english_meaning }}</li>{% endif %}
                        {% if word.phonetic %}<li>音標：{{ word.phonetic }}</li>{% endif %}
                        {% if word.example_sentence %}<li>例句：{{ word.example_sentence }}</li>{% endif %}
                        {% if word.synonyms %}<li>同義詞：{{ word.synonyms|join(', ') }}</li>{% endif %}
                        {% if word.antonyms %}<li>反義詞：{{ word.antonyms|join(', ') }}</li>{% endif %}
                    </ul>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <form method="POST" action="{{ url_for('delete_word', word_id=word.id) }}" style="display: inline;">
                    <button type="submit" class="btn btn-danger">
                        <i class="bi bi-trash"></i> 確認刪除
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// 刪除確認處理
document.addEventListener('DOMContentLoaded', function() {
    const deleteForm = document.querySelector('#deleteModal form');

    if (deleteForm) {
        deleteForm.addEventListener('submit', function() {
            const submitBtn = this.querySelector('button[type="submit"]');
            submitBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> 刪除中...';
            submitBtn.disabled = true;
        });
    }

    // 發音功能
    const pronunciationBtn = document.getElementById('pronunciationBtn');
    const wordText = '{{ word.word }}';

    if (pronunciationBtn && wordText) {
        pronunciationBtn.addEventListener('click', function() {
            playPronunciation(wordText);
        });
    }
});

function playPronunciation(word) {
    const btn = document.getElementById('pronunciationBtn');
    const originalContent = btn.innerHTML;

    // 設置載入狀態
    btn.innerHTML = '<i class="bi bi-hourglass-split"></i>';
    btn.disabled = true;

    // 構造音頻URL（使用雅虎字典）
    const audioUrl = `https://s.yimg.com/bg/dict/dreye/live/m/${word.toLowerCase()}.mp3`;
    console.log('嘗試播放音頻:', audioUrl);

    // 創建音頻元素
    const audio = new Audio();

    // 音頻載入開始
    audio.addEventListener('loadstart', function() {
        console.log('開始載入音頻...');
    });

    // 音頻載入成功，可以開始播放
    audio.addEventListener('canplay', function() {
        console.log('音頻載入成功，開始播放');
        btn.innerHTML = '<i class="bi bi-play-fill"></i>';
        btn.title = '播放中...';

        // 播放音頻
        audio.play().then(() => {
            console.log('音頻播放開始');
        }).catch((error) => {
            console.error('播放失敗:', error);
            handlePlaybackError();
        });
    });

    // 音頻播放結束
    audio.addEventListener('ended', function() {
        console.log('音頻播放結束');
        btn.innerHTML = originalContent;
        btn.disabled = false;
        btn.title = '播放發音';
    });

    // 音頻載入錯誤
    audio.addEventListener('error', function(e) {
        console.error('音頻載入錯誤:', e);
        console.error('錯誤類型:', audio.error);
        handlePlaybackError();
    });

    // 處理播放錯誤的函數
    function handlePlaybackError() {
        btn.innerHTML = '<i class="bi bi-volume-mute text-muted"></i>';
        btn.disabled = false;
        btn.title = '無法載入發音';

        // 顯示錯誤提示
        showNotification(`單字 "${word}" 暫無發音資源`, 'warning');

        // 3秒後恢復原狀
        setTimeout(() => {
            btn.innerHTML = originalContent;
            btn.title = '播放發音';
        }, 3000);
    }

    // 設置音頻源並開始載入
    audio.src = audioUrl;
    audio.load();

    // 設置超時處理（10秒後如果還沒載入成功就認為失敗）
    setTimeout(() => {
        if (btn.disabled && btn.innerHTML.includes('hourglass')) {
            console.log('載入超時');
            handlePlaybackError();
        }
    }, 10000);
}

function showNotification(message, type = 'info') {
    // 先移除現有的通知
    const existingNotifications = document.querySelectorAll('.pronunciation-notification');
    existingNotifications.forEach(n => n.remove());

    // 選擇圖示
    let icon = 'bi-info-circle';
    if (type === 'success') icon = 'bi-check-circle';
    else if (type === 'warning') icon = 'bi-exclamation-triangle';
    else if (type === 'danger') icon = 'bi-x-circle';

    // 創建通知元素
    const notification = document.createElement('div');
    notification.className = `alert alert-${type} alert-dismissible fade show position-fixed pronunciation-notification`;
    notification.style.cssText = 'top: 80px; right: 20px; z-index: 9999; min-width: 320px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);';
    notification.innerHTML = `
        <i class="bi ${icon}"></i> ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

    // 添加到頁面
    document.body.appendChild(notification);

    // 根據類型設置不同的自動移除時間
    const autoRemoveTime = type === 'info' ? 2000 : 3000;

    setTimeout(() => {
        if (notification.parentNode) {
            notification.classList.remove('show');
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 300);
        }
    }, autoRemoveTime);
}
</script>
{% endblock %}